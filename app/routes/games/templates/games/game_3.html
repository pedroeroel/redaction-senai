{% extends 'layout.html' %}
{% block pagename %}Montador de Frases{% endblock %}
{% block pagetext %}Arraste e solte as palavras para formar a frase correta!{% endblock %}
{% set header = True %}
{% set footer = True %}
{% set main = True %}

{% block content %}

<main
    id="main-content"
    class="bg-no-repeat bg-cover bg-center"
    style="background-image: url('../fundo-temas.png');">
    
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">

        <div class="max-w-4xl mx-auto mb-8 md:mb-12 text-center">
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4 leading-tight text-[#E8E1CF]">
                Montador de Frases üìù
            </h1>
            <p class="text-lg text-[#E8E1CF] opacity-90">
                Arraste e solte as palavras para formar a frase correta! Aten√ß√£o √† ordem e concord√¢ncia.
            </p>
            <hr class="border-t-2 border-[#E8E1CF] opacity-50 w-32 mx-auto mt-4">
        </div>

        <div class="max-w-4xl mx-auto bg-[#3D1E8D] p-6 rounded-xl shadow-lg">
            <div id="instructions" class="mb-6 text-center text-lg text-[#E8E1CF]">
                <p><strong>Desafio 1:</strong> Organize as palavras para formar uma frase coerente.</p>
            </div>

            <div id="wordBank" 
                 class="flex flex-wrap justify-center gap-4 p-4 bg-[#2A0F5E] rounded-lg mb-8">
            </div>

            <div id="sentenceDropZone" 
                 class="drop-zone flex flex-wrap items-center gap-2 p-4 bg-[#2A0F5E] rounded-lg mb-8">
                <p class="text-[#E8E1CF] opacity-70 italic" id="dropPlaceholder">
                    Arraste as palavras aqui para montar a frase...
                </p>
            </div>

            <div class="flex justify-center gap-4">
                <button id="checkButton" 
                        class="bg-[#A78BFA] text-[#2A0F5E] font-bold py-3 px-6 rounded-lg shadow-md hover:bg-[#C4B5FD] transition-all duration-200 ease-in-out">
                    Verificar Resposta
                </button>
                <button id="resetButton" 
                        class="bg-gray-600 text-[#E8E1CF] font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-700 transition-all duration-200 ease-in-out">
                    Reiniciar
                </button>
            </div>

            <div id="feedback" 
                 class="mt-6 p-4 rounded-lg text-center text-xl font-bold" 
                 style="display: none;">
            </div>
        </div>
    </div>
</main>

{% endblock %}


{% block scripts %}
<script>
    const wordBank = document.getElementById('wordBank');
    const sentenceDropZone = document.getElementById('sentenceDropZone');
    const dropPlaceholder = document.getElementById('dropPlaceholder');
    const checkButton = document.getElementById('checkButton');
    const resetButton = document.getElementById('resetButton');
    const feedback = document.getElementById('feedback');

    // Lista de desafios
const challenges = [
    {
        id: 1,
        prompt: "Organize as palavras para formar uma frase coerente.",
        words: ["A", "leitura", "√©", "fundamental", "para", "o", "desenvolvimento", "do", "conhecimento."],
        correctOrder: ["A",  "leitura", "√©", "fundamental", "para", "o", "desenvolvimento", "do", "conhecimento."],
        points: 5
    },
    {
        id: 2,
        prompt: "Forme uma frase sobre sustentabilidade e meio ambiente.",
        words: ["A", "sustentabilidade", "√©", "necess√°ria", "para", "proteger", "o", "futuro", "do", "planeta", "e", "garantir", "qualidade", "de", "vida."],
        correctOrder: ["A", "sustentabilidade", "√©", "necess√°ria", "para", "proteger", "o", "futuro", "do", "planeta", "e", "garantir", "qualidade", "de", "vida."],
        points: 10
    },
    {
        id: 3,
        prompt: "Monte uma frase que explique a import√¢ncia da educa√ß√£o.",
        words: ["A", "educa√ß√£o", "desenvolve", "habilidades", "e", "conhecimentos", "que", "s√£o", "essenciais", "para", "o", "futuro", "de", "cada", "indiv√≠duo."],
        correctOrder: ["A", "educa√ß√£o", "desenvolve", "habilidades", "e", "conhecimentos", "que", "s√£o", "essenciais", "para", "o", "futuro", "de", "cada", "indiv√≠duo."],
        points: 15
    },
    {
        id: 4,
        prompt: "Forme uma frase sobre h√°bitos de leitura.",
        words: ["Ler", "diariamente", "expande", "o", "vocabul√°rio,", "melhora", "a", "concentra√ß√£o", "e", "estimula", "a", "criatividade."],
        correctOrder: ["Ler", "diariamente", "expande", "o", "vocabul√°rio,", "melhora", "a", "concentra√ß√£o", "e", "estimula", "a", "criatividade."],
        points: 20
    }
];


    let currentChallengeIndex = 0;
    let currentChallenge;

    function loadChallenge() {
        if (currentChallengeIndex >= challenges.length) {
            feedback.style.display = 'block';
            feedback.className = 'mt-6 p-4 rounded-lg text-center text-xl font-bold bg-green-500 text-white';
            feedback.innerText = 'üéâ Parab√©ns! Voc√™ completou todos os desafios! Redirecionando...';

            // ‚è≥ Aguarda 2 segundos e redireciona
            setTimeout(() => {
                window.location.href = '/games';
            }, 2000);

            wordBank.innerHTML = '';
            sentenceDropZone.innerHTML = '';
            checkButton.style.display = 'none';
            resetButton.style.display = 'none';
            return;
        }

        currentChallenge = challenges[currentChallengeIndex];
        document.getElementById('instructions').innerHTML = 
            `<p><strong>Desafio ${currentChallenge.id}:</strong> ${currentChallenge.prompt}</p>`;
        
        // Limpa as √°reas
        wordBank.innerHTML = '';
        sentenceDropZone.innerHTML = '';
        dropPlaceholder.style.display = 'block';
        feedback.style.display = 'none';

        // Embaralha palavras
        const shuffledWords = [...currentChallenge.words].sort(() => Math.random() - 0.5);
        shuffledWords.forEach(wordText => {
            const wordElement = document.createElement('div');
            wordElement.classList.add('draggable', 'bg-[#A78BFA]', 'text-[#2A0F5E]', 'py-2', 'px-4', 'rounded-lg', 'shadow-md', 'hover:bg-[#C4B5FD]', 'transition-colors', 'duration-200');
            wordElement.innerText = wordText;
            wordElement.setAttribute('draggable', 'true');
            wordBank.appendChild(wordElement);
        });

        addDragAndDropListeners();
    }

    function addDragAndDropListeners() {
        const draggables = document.querySelectorAll('.draggable');
        
        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', () => draggable.classList.add('dragging'));
            draggable.addEventListener('dragend', () => draggable.classList.remove('dragging'));
        });

        sentenceDropZone.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(sentenceDropZone, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (!draggable) return;
            if (!afterElement) sentenceDropZone.appendChild(draggable);
            else sentenceDropZone.insertBefore(draggable, afterElement);
            dropPlaceholder.style.display = 'none';
        });

        wordBank.addEventListener('dragover', e => e.preventDefault());
        wordBank.addEventListener('drop', e => {
            e.preventDefault();
            const draggable = document.querySelector('.dragging');
            if (draggable) wordBank.appendChild(draggable);
            if (sentenceDropZone.children.length === 1 && sentenceDropZone.children[0] === dropPlaceholder)
                dropPlaceholder.style.display = 'block';
        });
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.draggable:not(.dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) return { offset, element: child };
            return closest;
        }, { offset: -Infinity }).element;
    }

    // ‚úÖ SEND POINTS TO BACKEND WHEN WON
    checkButton.addEventListener('click', async () => {
        const assembledWords = Array.from(sentenceDropZone.children)
                                .filter(el => el !== dropPlaceholder)
                                .map(el => el.innerText.trim());
        
        const correctSentence = currentChallenge.correctOrder.join(' ');
        const userSentence = assembledWords.join(' ');

        if (userSentence === correctSentence) {
            feedback.style.display = 'block';
            feedback.className = 'mt-6 p-4 rounded-lg text-center text-xl font-bold bg-green-500 text-white';
            feedback.innerText = `üéâ Parab√©ns! Frase Correta! +${currentChallenge.points} XP`;

            // üîπ Envia pontos ao backend Flask
            try {
                const response = await fetch('/points/redeem', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        points: currentChallenge.points
                    })
                });

                if (!response.ok) {
                    console.error('Erro ao enviar pontos:', await response.text());
                }
            } catch (error) {
                console.error('Erro na requisi√ß√£o de pontos:', error);
            }

            // Avan√ßa para o pr√≥ximo desafio ap√≥s um pequeno atraso
            setTimeout(() => {
                currentChallengeIndex++;
                loadChallenge();
            }, 1500);

        } else {
            feedback.style.display = 'block';
            feedback.className = 'mt-6 p-4 rounded-lg text-center text-xl font-bold bg-red-500 text-white';
            feedback.innerText = '‚ùå Ops! Tente novamente. A ordem ou concord√¢ncia pode estar errada.';
        }
    });

    resetButton.addEventListener('click', loadChallenge);
    loadChallenge();
</script>

<style>
    body { overflow-y: hidden; }
    #main-content { height: calc(100vh - 5rem); overflow-y: auto; }
    .draggable { cursor: grab; user-select: none; }
    .draggable.dragging { opacity: 0.5; cursor: grabbing; }
    .drop-zone { min-height: 100px; border: 2px dashed #A78BFA; }
</style>
{% endblock %}
