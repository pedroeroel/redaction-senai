{% extends 'layout.html' %}
{% block pagename %}Duelo de Conectivos{% endblock %}
{% block pagetext %}Escolha os conectivos certos para vencer o duelo!{% endblock %}
{% set header = True %}
{% set footer = True %}
{% set main = True %}

{% block content %}
<main
    id="main-content"
    class="bg-no-repeat bg-cover bg-center"
    style="background-image: url('../fundo-temas.png');">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">

        <div class="max-w-4xl mx-auto mb-8 md:mb-12 text-center">
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4 leading-tight text-[#E8E1CF]">
                Duelo de Conectivos ‚öîÔ∏è
            </h1>
            <p class="text-lg text-[#E8E1CF] opacity-90">
                Escolha o conectivo mais adequado para completar cada frase!
            </p>
            <hr class="border-t-2 border-[#E8E1CF] opacity-50 w-32 mx-auto mt-4">
        </div>

        <div class="max-w-4xl mx-auto bg-[#3D1E8D] p-6 rounded-xl shadow-lg">
            <div id="instructions" class="mb-6 text-center text-lg text-[#E8E1CF]">
                <p><strong>N√≠vel 1:</strong> Complete corretamente as frases com os conectivos adequados.</p>
            </div>

            <div id="questionsContainer" class="bg-[#2A0F5E] p-6 rounded-lg mb-8 text-xl leading-relaxed text-[#E8E1CF]">
            </div>

            <div class="flex flex-col items-center gap-4">
                <div id="feedback" class="p-4 rounded-lg text-center text-lg font-bold w-full" style="display: none;"></div>

                <button id="checkButton"
                        class="bg-[#A78BFA] text-[#2A0F5E] font-bold py-3 px-6 rounded-lg shadow-md hover:bg-[#C4B5FD] transition-all duration-200 ease-in-out">
                    Verificar Respostas
                </button>
                <button id="nextChallengeButton"
                        class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all duration-200 ease-in-out"
                        style="display: none;">
                    Pr√≥ximo N√≠vel
                </button>
                <button id="resetButton"
                        class="bg-gray-600 text-[#E8E1CF] font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-700 transition-all duration-200 ease-in-out">
                    Reiniciar Desafio
                </button>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script>
    const questionsContainer = document.getElementById('questionsContainer');
    const instructions = document.getElementById('instructions');
    const feedback = document.getElementById('feedback');
    const checkButton = document.getElementById('checkButton');
    const nextChallengeButton = document.getElementById('nextChallengeButton');
    const resetButton = document.getElementById('resetButton');

    const challenges = [
        {
            id: 1,
            prompt: "Complete as frases com o conectivo mais adequado.",
            questions: [
                { sentence: "Eu queria sair, ______ estava chovendo.", options: ["mas", "portanto", "logo"], correct: "mas" },
                { sentence: "Estude bastante, ______ ter√° bons resultados.", options: ["contudo", "logo", "embora"], correct: "logo" },
                { sentence: "N√£o fomos ao parque, ______ come√ßou a chover.", options: ["porque", "portanto", "por√©m"], correct: "porque" }
            ],
            points: 5
        },
        {
            id: 2,
            prompt: "Escolha os conectivos corretos para expressar causa, consequ√™ncia e oposi√ß√£o.",
            questions: [
                { sentence: "Ele estava cansado, ______ continuou trabalhando.", options: ["mas", "portanto", "logo"], correct: "mas" },
                { sentence: "Os alunos se dedicaram muito, ______ conquistaram boas notas.", options: ["porque", "embora", "portanto"], correct: "portanto" },
                { sentence: "N√£o jogamos futebol, ______ estava chovendo.", options: ["pois", "entretanto", "logo"], correct: "pois" }
            ],
            points: 10
        },
        {
            id: 3,
            prompt: "Escolha o conectivo que melhor mant√©m a coes√£o e o sentido l√≥gico das frases.",
            questions: [
                { sentence: "Ela n√£o estudou, ______ passou na prova.", options: ["embora", "pois", "portanto"], correct: "embora" },
                { sentence: "Farei o trabalho hoje, ______ amanh√£ n√£o terei tempo.", options: ["porque", "contudo", "al√©m disso"], correct: "porque" },
                { sentence: "Gosto de ler romances, ______ tamb√©m aprecio biografias.", options: ["mas", "portanto", "al√©m disso"], correct: "al√©m disso" }
            ],
            points: 15
        },
        {
            id: 4,
            prompt: "Complete com o conectivo adequado considerando o tipo de rela√ß√£o sem√¢ntica (adi√ß√£o, explica√ß√£o, conclus√£o, concess√£o).",
            questions: [
                { sentence: "O time jogou bem, ______ perdeu a partida.", options: ["contudo", "portanto", "logo"], correct: "contudo" },
                { sentence: "As estradas estavam perigosas, ______ chovia sem parar.", options: ["pois", "embora", "logo"], correct: "pois" },
                { sentence: "Terminamos cedo, ______ pudemos descansar mais.", options: ["assim", "por√©m", "embora"], correct: "assim" }
            ],
            points: 20
        },
        {
            id: 5,
            prompt: "Desafio final: conectivos em contextos complexos e sutis.",
            questions: [
                { sentence: "A empresa obteve lucro, ______ reduziu gastos e aumentou as vendas.", options: ["porque", "pois", "j√° que"], correct: "porque" },
                { sentence: "Ele foi promovido, ______ ainda enfrenta muitos desafios.", options: ["embora", "portanto", "assim"], correct: "embora" },
                { sentence: "O tr√¢nsito estava intenso, ______ chegamos a tempo.", options: ["mesmo assim", "portanto", "por isso"], correct: "mesmo assim" }
            ],
            points: 20
        }
    ];

    let currentChallengeIndex = 0;
    let currentChallenge;
    let totalPoints = 0;

    function loadChallenge() {
        if (currentChallengeIndex >= challenges.length) {
            showCompletionMessage();
            return;
        }

        currentChallenge = challenges[currentChallengeIndex];
        instructions.innerHTML = `<p><strong>N√≠vel ${currentChallenge.id}:</strong> ${currentChallenge.prompt}</p>`;
        feedback.style.display = 'none';
        nextChallengeButton.style.display = 'none';
        checkButton.style.display = 'block';
        questionsContainer.innerHTML = '';

        currentChallenge.questions.forEach((q, index) => {
            const optionsHTML = q.options.map(opt => `
                <label class="inline-flex items-center gap-2 mb-2 cursor-pointer">
                    <input type="radio" name="q${index}" value="${opt}" class="accent-[#A78BFA]">
                    <span>${opt}</span>
                </label>
            `).join('<br>');

            const questionHTML = `
                <div class="mb-6">
                    <p class="mb-3"><strong>${index + 1}.</strong> ${q.sentence.replace('______', '<span class="underline underline-offset-4 decoration-wavy decoration-[#EF4444]">______</span>')}</p>
                    <div>${optionsHTML}</div>
                </div>
            `;
            questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
        });
    }

    checkButton.addEventListener('click', async () => {
        const total = currentChallenge.questions.length;
        let correct = 0;

        currentChallenge.questions.forEach((q, index) => {
            const selected = document.querySelector(`input[name="q${index}"]:checked`);
            if (selected && selected.value === q.correct) correct++;
        });

        feedback.style.display = 'block';

        const pointsEarned = Math.floor((correct / total) * currentChallenge.points);
        totalPoints += pointsEarned;

        if (correct === total) {
            feedback.className = 'mt-6 p-4 rounded-lg text-center text-xl font-bold bg-green-500 text-white';
            feedback.innerText = `üéâ Parab√©ns! Voc√™ acertou todas! +${currentChallenge.points} XP (Total: ${totalPoints} XP)`;

            try {
                await fetch('/points/redeem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ points: totalPoints })
                });
            } catch (err) {
                console.error('Erro ao comunicar com o servidor:', err);
            }

            checkButton.style.display = 'none';
            nextChallengeButton.style.display = 'block';
        } else {
            feedback.className = 'mt-6 p-4 rounded-lg text-center text-xl font-bold bg-red-500 text-white';
            feedback.innerText = `Voc√™ acertou ${correct} de ${total}. Pontos ganhos neste n√≠vel: ${pointsEarned} XP (Total: ${totalPoints} XP). Tente novamente!`;
        }
    });

    nextChallengeButton.addEventListener('click', () => {
        currentChallengeIndex++;
        loadChallenge();
    });

    resetButton.addEventListener('click', () => {
        totalPoints = 0;
        currentChallengeIndex = 0;
        loadChallenge();
    });

    function showCompletionMessage() {
        questionsContainer.innerHTML = `<p class="text-3xl font-bold text-center">üèÜ Voc√™ completou o Duelo de Conectivos! Total de XP ganho: ${totalPoints}</p>`;
        instructions.innerHTML = '';
        feedback.style.display = 'none';
        checkButton.style.display = 'none';
        nextChallengeButton.style.display = 'none';
        resetButton.style.display = 'none';

        setTimeout(() => {
            window.location.href = '/games';
        }, 3000);
    }

    loadChallenge();
</script>

<style>
    body { overflow-y: hidden; }
    #main-content { height: calc(100vh - 5rem); overflow-y: auto; }
    input[type="radio"] { transform: scale(1.2); }
</style>
{% endblock %}
