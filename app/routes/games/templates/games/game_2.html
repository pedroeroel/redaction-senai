{% extends 'layout.html' %}
{% block pagename %}Corretor Fantasma{% endblock %}
{% block pagetext %}Clique nas palavras erradas e corrija-as!{% endblock %}
{% set header = True %}
{% set footer = True %}
{% set main = True %}

{% block content %}
<main
    id="main-content"
    class="bg-no-repeat bg-cover bg-center"
    style="background-image: url('../fundo-temas.png');">
    
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 md:py-16">

        <div class="max-w-4xl mx-auto mb-8 md:mb-12 text-center">
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4 leading-tight text-[#E8E1CF]">
                Corretor Fantasma üëª
            </h1>
            <p class="text-lg text-[#E8E1CF] opacity-90">
                Clique nas palavras ou trechos que voc√™ considera errados e tente corrigi-los!
            </p>
            <hr class="border-t-2 border-[#E8E1CF] opacity-50 w-32 mx-auto mt-4">
        </div>

        <div class="max-w-4xl mx-auto bg-[#3D1E8D] p-6 rounded-xl shadow-lg">
            <div id="instructions" class="mb-6 text-center text-lg text-[#E8E1CF]">
                <p><strong>N√≠vel 1:</strong> Encontre 3 erros de ortografia e concord√¢ncia no texto abaixo.</p>
            </div>

            <div id="textContainer" class="bg-[#2A0F5E] p-6 rounded-lg mb-8 text-xl leading-relaxed text-[#E8E1CF]">
            </div>

            <div class="flex flex-col items-center gap-4">
                <div id="feedback" class="p-4 rounded-lg text-center text-lg font-bold w-full" style="display: none;"></div>
                
                <button id="checkButton" 
                        class="bg-[#A78BFA] text-[#2A0F5E] font-bold py-3 px-6 rounded-lg shadow-md hover:bg-[#C4B5FD] transition-all duration-200 ease-in-out">
                    Verificar Todos os Erros
                </button>
                <button id="nextChallengeButton" 
                        class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-all duration-200 ease-in-out"
                        style="display: none;">
                    Pr√≥ximo Desafio
                </button>
                <button id="resetButton" 
                        class="bg-gray-600 text-[#E8E1CF] font-bold py-3 px-6 rounded-lg shadow-md hover:bg-gray-700 transition-all duration-200 ease-in-out">
                    Reiniciar Desafio
                </button>
            </div>
        </div>
    </div>
</main>
{% endblock %}


{% block scripts %}
<script>
    const textContainer = document.getElementById('textContainer');
    const instructions = document.getElementById('instructions');
    const feedback = document.getElementById('feedback');
    const checkButton = document.getElementById('checkButton');
    const nextChallengeButton = document.getElementById('nextChallengeButton');
    const resetButton = document.getElementById('resetButton');

    // --- Lista de desafios ---
const challenges = [
    {
        id: 1,
        prompt: "Encontre os erros de <strong>ortografia e acentua√ß√£o</strong> no par√°grafo.",
        text: "A sustentabilidade √© um tema fundamental. Muitas pess√¥as n√£o compreendem a *importancia de a√ß√µes sustentaveis para o futuro do planeta. √â preciso que a socied√°de se mobilizem para proteger o meio ambiente.",
        errors: [
            { word: "pess√¥as", correction: "pessoas", explanation: "Erro de ortografia: 'pessoas' se escreve com 'ss'." },
            { word: "importancia", correction: "import√¢ncia", explanation: "Erro de acentua√ß√£o: 'import√¢ncia' tem acento agudo no 'a'." },
            { word: "sustentaveis", correction: "sustent√°veis", explanation: "Erro de acentua√ß√£o: 'sustent√°veis' tem acento agudo no 'a'." },
            { word: "socied√°de", correction: "sociedade", explanation: "Erro de ortografia: 'sociedade' se escreve sem acento." },
            { word: "mobilizem", correction: "mobilize", explanation: "Erro de concord√¢ncia verbal: 'a sociedade' (singular) mobiliza (singular)." }
        ],
        points: 5
    },
    {
        id: 2,
        prompt: "Identifique erros de <strong>coes√£o e uso de conectivos</strong> no par√°grafo.",
        text: "O Brasil √© um pa√≠s rico em diversidade cultural, *no entanto*, muitos desafios sociais persistem. A educa√ß√£o √© um caminho para a mudan√ßa, *assim, pois*, √© fundamental investir nela. *Mesmo assim*, a popula√ß√£o precisa se engajar.",
        errors: [
            { word: "no entanto", correction: "e", explanation: "O conectivo 'no entanto' indica oposi√ß√£o. Aqui, 'e' conecta melhor as ideias sem criar contraste." },
            { word: "assim, pois", correction: "portanto", explanation: "Erro de redund√¢ncia: 'portanto' j√° expressa consequ√™ncia, dispensando 'assim, pois'." },
            { word: "Mesmo assim", correction: "Al√©m disso", explanation: "O conectivo 'mesmo assim' indica concess√£o; 'Al√©m disso' √© mais adequado para adi√ß√£o de informa√ß√£o." }
        ],
        points: 10
    },
    {
        id: 3,
        prompt: "Corrija erros de <strong>pontua√ß√£o e concord√¢ncia</strong> no texto.",
        text: "As crian√ßas adoram brincar no parque mas, muitas vezes esquecem de levar os brinquedos de casa. O professor e os alunos, precisa manter a organiza√ß√£o durante a aula.",
        errors: [
            { word: "mas,", correction: "mas", explanation: "Erro de pontua√ß√£o: a v√≠rgula ap√≥s 'mas' n√£o √© necess√°ria aqui." },
            { word: "e os alunos,", correction: "e os alunos", explanation: "Erro de pontua√ß√£o: a v√≠rgula ap√≥s 'alunos' quebra a frase desnecessariamente." },
            { word: "precisa", correction: "precisam", explanation: "Erro de concord√¢ncia verbal: 'professor e os alunos' (plural) exige 'precisam'." }
        ],
        points: 15
    },
    {
        id: 4,
        prompt: "Corrija erros de <strong>coer√™ncia, conectivos e ortografia</strong> no par√°grafo.",
        text: "Maria estudou bastante, portanto, ela n√£o passou na prova. Ela n√£o se sentiu desanimada, pelo contrario, estava motivada para tentar novamente. Mesmo assim ela estudou pouco para a segunda avalia√ß√£o.",
        errors: [
            { word: "portanto,", correction: "mas", explanation: "Erro de coer√™ncia: 'portanto' indica consequ√™ncia, mas o sentido da frase √© contraste." },
            { word: "pelo contrario", correction: "pelo contr√°rio", explanation: "Erro de ortografia: 'contr√°rio' deve ter acento." },
            { word: "Mesmo assim ela", correction: "No entanto, ela", explanation: "Erro de conectivo: 'No entanto' expressa melhor o contraste nesta frase." }
        ],
        points: 20
    }
];

    let currentChallengeIndex = 0;
    let currentChallenge;
    let clickedErrors = new Set();

function loadChallenge() {
    if (currentChallengeIndex >= challenges.length) {
        showCompletionMessage();
        return;
    }

    currentChallenge = challenges[currentChallengeIndex];
    instructions.innerHTML = `<p><strong>N√≠vel ${currentChallenge.id}:</strong> ${currentChallenge.prompt}</p>`;
    textContainer.innerHTML = '';
    feedback.style.display = 'none';
    nextChallengeButton.style.display = 'none';
    checkButton.style.display = 'block';
    clickedErrors.clear();

    let displayText = currentChallenge.text;

    currentChallenge.errors.forEach((error, index) => {
        // Escapa caracteres especiais do regex
        const escapedWord = error.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        // Regex para encontrar a palavra, com ou sem asteriscos
        const regex = new RegExp(`\\*?${escapedWord}\\*?`, 'gi');

        displayText = displayText.replace(regex, match => {
            // Remove asteriscos do display
            const cleanMatch = match.replace(/\*/g, '');
            return `<span class="error-word" data-error-index="${index}">${cleanMatch}</span>`;
        });
    });

    textContainer.innerHTML = displayText;

    document.querySelectorAll('.error-word').forEach(wordElement => {
        wordElement.addEventListener('click', handleWordClick);
    });
}

function handleWordClick(event) {
    const clicked = event.target;
    const errorIndex = parseInt(clicked.dataset.errorIndex);
    const error = currentChallenge.errors[errorIndex];

    if (!error) return;

    if (!clickedErrors.has(errorIndex)) {
        clickedErrors.add(errorIndex);
        clicked.classList.add('corrected');
        feedback.style.display = 'block';
        feedback.className = 'mt-6 p-4 rounded-lg text-center text-lg font-bold bg-green-500 text-white';
        feedback.innerHTML = `üéâ Erro encontrado!<br>Corre√ß√£o: "${error.correction}"<br><em>${error.explanation}</em>`;

        // Atualiza o texto no span para a corre√ß√£o
        clicked.innerText = error.correction;

    } else {
        feedback.style.display = 'block';
        feedback.className = 'mt-6 p-4 rounded-lg text-center text-lg font-bold bg-blue-500 text-white';
        feedback.innerText = 'Voc√™ j√° corrigiu este erro!';
    }
}

    // ‚úÖ CHECK & REDEEM POINTS
    checkButton.addEventListener('click', async () => {
        const totalErrors = currentChallenge.errors.length;
        const found = clickedErrors.size;

        if (found === totalErrors) {
            feedback.style.display = 'block';
            feedback.className = 'mt-6 p-4 rounded-lg text-center text-xl font-bold bg-green-500 text-white';
            feedback.innerText = `ü•≥ Excelente! Voc√™ encontrou todos os ${totalErrors} erros! +${currentChallenge.points} XP`;

            // üîπ Envia pontos ao backend Flask
            try {
                const response = await fetch('/points/redeem', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({ points: currentChallenge.points })
                });
                if (!response.ok) {
                    console.error('Erro ao enviar pontos:', await response.text());
                }
            } catch (err) {
                console.error('Erro ao comunicar com o servidor:', err);
            }

            checkButton.style.display = 'none';
            nextChallengeButton.style.display = 'block';

        } else {
            feedback.style.display = 'block';
            feedback.className = 'mt-6 p-4 rounded-lg text-center text-xl font-bold bg-red-500 text-white';
            feedback.innerText = `Voc√™ encontrou ${found} de ${totalErrors} erros. Continue procurando!`;
        }
    });

    nextChallengeButton.addEventListener('click', () => {
        currentChallengeIndex++;
        loadChallenge();
    });

    resetButton.addEventListener('click', () => loadChallenge());

    function showCompletionMessage() {
        textContainer.innerHTML = `<p class="text-3xl font-bold text-center">üéâ Parab√©ns! Voc√™ encontrou todos os erros e completou o jogo!</p>`;
        instructions.innerHTML = '';
        feedback.style.display = 'none';
        checkButton.style.display = 'none';
        nextChallengeButton.style.display = 'none';
        resetButton.style.display = 'none';

        // Redireciona com delay
        setTimeout(() => {
            window.location.href = '/games';
        }, 2000);
    }

    loadChallenge();
</script>

<style>
    body { overflow-y: hidden; }
    #main-content { height: calc(100vh - 5rem); overflow-y: auto; }

.error-word {
    cursor: pointer;
    text-decoration: none; /* sem underline */
    font-weight: normal;    /* sem negrito */
    color: inherit;         /* mesma cor do texto */
}


.error-word.corrected {
    color: #22C55E;         /* verde para indicar corre√ß√£o */
    font-weight: bold;       /* opcional */
    text-decoration: none;
}

</style>
{% endblock %}
