{% extends "layout.html" %}
{% set header = True %}
{% set footer = True %}
{% set main = True %}

{% block pagename %}{{ class_content.title }}{% endblock %}
{% block pagetext %}Mini-Aula Interativa{% endblock %}

{% block content %}
<main class="min-h-screen bg-[#2A0F5E] text-[#E8E1CF]">
  <div class="container mx-auto px-6 py-10 md:py-16">

    <!-- Header -->
    <div class="mb-10 text-center">
      <h1 class="text-4xl font-bold mb-3">{{ class_content.title }}</h1>
      <p class="text-lg opacity-90">{{ class_content.description }}</p>
      <div class="flex justify-center gap-4 mt-3 text-sm opacity-75">
        <span>ðŸ•’ {{ class_content.duration }}</span>
        <span>ðŸŽ¯ {{ class_content.level }}</span>
        <span>ðŸ“š {{ class_content.category }}</span>
      </div>
    </div>

    <!-- TÃ³picos -->
{% for topic in class_content.topics %}
{% set c = topic.content if topic.content is defined else topic %}

<section class="bg-[#3D1E8D] p-6 sm:p-8 rounded-2xl shadow-xl mb-10">
  <h2 class="text-2xl font-semibold mb-4 text-[#A78BFA]">{{ topic.title }}</h2>

  {% if c.paragraphs %}
  {% for p in c.paragraphs %}
  <p class="mb-3 leading-relaxed opacity-90">{{ p }}</p>
  {% endfor %}
  {% endif %}

  {% if c.tip %}
  <div class="mt-4 p-4 bg-[#5A3E9D] rounded-lg italic text-sm opacity-90">
    ðŸ’¡ {{ c.tip }}
  </div>
  {% endif %}

  {% if c.list_items %}
  <ul class="list-disc list-inside space-y-2 mt-4">
    {% for item in c.list_items %}
    <li><strong>{{ item.title }}:</strong> {{ item.text }}</li>
    {% endfor %}
  </ul>
  {% endif %}

  {% if c.question %}
  <div class="mt-6">
    <h3 class="text-xl font-semibold mb-3">ðŸŽ¯ Desafio Interativo</h3>
    <p class="mb-4">{{ c.question }}</p>

    <!-- FIXED: options sorted (a,b,c...) -->
    <form class="quiz-form"
          data-correct="{{ c.correct_answer }}"
          data-correct-feedback="{{ c.correct_feedback }}"
          data-wrong-feedback="{{ c.wrong_feedback }}">

      {% for key, value in c.options|dictsort %}
      <label class="block bg-[#5A3E9D] p-3 rounded-lg cursor-pointer hover:bg-[#7254B4] transition-colors">
        <input type="radio" name="resposta" value="{{ key }}" class="mr-2 accent-[#A78BFA]">
        <span>{{ key }}) {{ value }}</span>
      </label>
      {% endfor %}

      <div class="quiz-feedback mt-4 hidden p-3 rounded-lg"></div>
    </form>
  </div>
  {% endif %}

  {% if c.materials %}
  <div class="mt-6">
    <h3 class="text-xl font-semibold mb-3">ðŸ“– Materiais</h3>
    <ul class="space-y-2">
      {% for material in c.materials %}
      <li>
        <a href="{{ material.link }}" target="_blank" class="underline hover:text-[#A78BFA]">
          ðŸŽ¬ {{ material.title }} ({{ material.type }})
        </a>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  {% if c.challenge %}
  <div class="mt-4 p-4 bg-[#5A3E9D] rounded-lg italic text-sm opacity-90">
    ðŸš€ {{ c.challenge }}
  </div>
  {% endif %}
</section>

{% endfor %}
      </ul>
      {% endif %}

      <!-- Pergunta interativa -->
      {% if c.question %}
      <div class="mt-6">
        <h3 class="text-xl font-semibold mb-3">ðŸŽ¯ Desafio Interativo</h3>
        <p class="mb-4">{{ c.question }}</p>

        <form class="quiz-form space-y-2"
          data-correct="{{ c.correct_answer }}"
          data-correct-feedback="{{ c.correct_feedback }}"
          data-wrong-feedback="{{ c.wrong_feedback }}">
          {% for key, value in c.options.items() %}
          <label
            class="block bg-[#5A3E9D] p-3 rounded-lg cursor-pointer hover:bg-[#7254B4] transition-colors">
            <input type="radio" name="resposta" value="{{ key }}" class="mr-2 accent-[#A78BFA]">
            <span>{{ value }}</span>
          </label>
          {% endfor %}
          <div class="quiz-feedback mt-4 hidden p-3 rounded-lg"></div>
        </form>
      </div>
      {% endif %}

      {% if c.materials %}
      <div class="mt-6">
        <h3 class="text-xl font-semibold mb-3">ðŸ“– Materiais</h3>
        <ul class="space-y-2">
          {% for material in c.materials %}
          <li>
            <a href="{{ material.link }}" target="_blank" class="underline hover:text-[#A78BFA]">
              ðŸŽ¬ {{ material.title }} ({{ material.type }})
            </a>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}

      {% if c.challenge %}
      <div class="mt-4 p-4 bg-[#5A3E9D] rounded-lg italic text-sm opacity-90">
        ðŸš€ {{ c.challenge }}
      </div>
      {% endif %}
    </section>
    {% endfor %}

    <!-- BotÃ£o final -->
    <div class="text-center mt-10">
      <button id="finish-btn"
        class="px-10 py-4 bg-gray-500 text-[#2A0F5E] text-lg font-bold rounded-full shadow-lg opacity-50 cursor-not-allowed transition-all duration-300">
        Complete todos os desafios para concluir âœ¨
      </button>
    </div>
  </div>
</main>

<!-- JS -->

<script>
document.addEventListener("DOMContentLoaded", () => {
  const quizForms = document.querySelectorAll(".quiz-form");
  const finishBtn = document.getElementById("finish-btn");
  let correctAnswers = new Set();

  function updateFinishButton() {
    if (quizForms.length > 0 && correctAnswers.size === quizForms.length) {
      finishBtn.className =
        "px-10 py-4 bg-[#A78BFA] text-[#2A0F5E] text-lg font-bold rounded-full shadow-lg hover:bg-white hover:text-[#2A0F5E] transition-all duration-300 transform hover:scale-105";
      finishBtn.textContent = "Concluir Aula e Ganhar XP! âœ¨";
      finishBtn.disabled = false;
      finishBtn.style.cursor = "pointer";
      finishBtn.style.opacity = "1";
    } else {
      finishBtn.className =
        "px-10 py-4 bg-gray-500 text-[#2A0F5E] text-lg font-bold rounded-full shadow-lg opacity-50 cursor-not-allowed transition-all duration-300";
      finishBtn.textContent = "Complete todos os desafios para concluir âœ¨";
      finishBtn.disabled = true;
      finishBtn.style.cursor = "not-allowed";
      finishBtn.style.opacity = "0.5";
    }
  }

  quizForms.forEach((form, index) => {
    const feedback = form.querySelector(".quiz-feedback");
    const rawCorrect = (form.dataset.correct || "").trim().toLowerCase();
    const correctFeedback = form.dataset.correctFeedback || "Boa!";
    const wrongFeedback = form.dataset.wrongFeedback || "Tente novamente!";

    form.addEventListener("submit", e => {
      e.preventDefault();

      const radios = Array.from(form.querySelectorAll('input[name="resposta"]'));
      const selected = radios.find(r => r.checked);

      if (!selected) {
        feedback.className = "quiz-feedback mt-4 p-3 rounded-lg bg-yellow-500";
        feedback.innerText = "Por favor, selecione uma opÃ§Ã£o!";
        return;
      }

      const optionKeys = radios.map(r => r.value.trim().toLowerCase());
      const selectedValue = selected.value.trim().toLowerCase();
      const selectedIndex = radios.findIndex(r => r === selected);
      const selectedLabel = (selected.closest("label")?.innerText || "").toLowerCase();

      let isCorrect = false;

      // Case 1 â€” exact letter (a,b,c)
      if (/^[a-z]$/.test(rawCorrect)) {
        isCorrect = (selectedValue === rawCorrect);
      }

      // Case 2 â€” numeric index (0 or 1-based)
      if (!isCorrect && /^[0-9]+$/.test(rawCorrect)) {
        const n = parseInt(rawCorrect, 10);
        if (selectedIndex === n || selectedIndex === n - 1) isCorrect = true;
      }

      // Case 3 â€” label text matching
      if (!isCorrect) {
        if (selectedLabel.startsWith(rawCorrect)) isCorrect = true;
        if (selectedLabel.includes(rawCorrect)) isCorrect = true;
      }

      // Apply result
      if (isCorrect) {
        feedback.className = "quiz-feedback mt-4 p-3 rounded-lg bg-green-500 text-[#E8E1CF]";
        feedback.innerHTML = "âœ… " + correctFeedback;
        correctAnswers.add(index);
      } else {
        feedback.className = "quiz-feedback mt-4 p-3 rounded-lg bg-red-500 text-[#E8E1CF]";
        feedback.innerHTML = "âŒ " + wrongFeedback;
        correctAnswers.delete(index);
      }

      updateFinishButton();
    });

    // Auto-submit when selecting
    form.querySelectorAll('input[name="resposta"]').forEach(radio => {
      radio.addEventListener("change", () => {
        form.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
      });
    });

  });

  updateFinishButton();
});
</script>

{% endblock %}