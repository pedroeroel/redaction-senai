{% extends 'layout.html' %}
{% block pagename %}Detalhes da Redação{% endblock %}
{% block pagetext %}Análise completa da sua redação{% endblock %}
{% set main = True %}
{% set header = True %}
{% set footer = True %}

{% block content %}

<div class="max-w-4xl mx-auto p-6 text-white">

    <!-- HEADER -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold">{{ essay.title or "Redação Sem Título" }}</h1>

        <a href="{{ url_for('essay.my_essays') }}"
           class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg shadow transition font-semibold">
            ←
        </a>
    </div>

    <!-- ESSAY SECTION -->
    <div class="bg-[#3b2a52] p-6 rounded-xl shadow-lg mb-10">

        <h2 class="text-2xl font-semibold mb-3">Tema</h2>
        <p class="text-lg text-gray-200 mb-6">{{ essay.theme or "Indefinido" }}</p>

        <div class="bg-[#2a1d3b] p-4 rounded-lg border border-white/10 max-h-96 overflow-y-auto whitespace-pre-wrap">
            {{ essay.content or "Conteúdo indisponível." }}
        </div>
    </div>

    <!-- ANALYSIS SECTION -->
    <div class="bg-[#3b2a52] p-6 rounded-xl shadow-lg">

        <!-- TITLE + GRADE -->
        <div class="flex justify-between items-center border-b border-white/20 pb-4 mb-6">
            <h2 class="text-2xl font-bold">Análise de Desempenho</h2>

            <div class="text-3xl bg-emerald-600 px-4 py-2 rounded-lg font-extrabold shadow">
                {{ essay.grade or "N/A" }}/1000
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

            <!-- PIE CHART -->
            <div class="flex justify-center items-center">
                <canvas id="competencyChart" width="300" height="300"></canvas>
            </div>

            <!-- COMMENTS -->
            <div>
                <h3 class="text-xl font-bold mb-4">Comentários por Competência</h3>

                {% for score in essay.competencies %}
                    <div class="bg-[#2a1d3b] p-4 rounded-lg border-l-4 border-emerald-400 mb-3">
                        <p class="font-bold text-white">
                            Competência {{ loop.index }}:
                            <span class="text-emerald-300">{{ score }}/200</span>
                        </p>

                        {% if essay.comments[loop.index0] %}
                            <p class="mt-2 text-gray-300">{{ essay.comments[loop.index0] }}</p>
                        {% else %}
                            <p class="mt-2 text-gray-400 italic">Sem comentário disponível.</p>
                        {% endif %}
                    </div>
                {% endfor %}

                <!-- GENERAL COMMENT -->
                {% if essay.comments|length > 5 %}
                <div class="bg-[#2a1d3b] p-4 rounded-lg border-l-4 border-purple-400 mt-6">
                    <p class="font-bold text-white">Comentário Geral:</p>
                    <p class="mt-2 text-gray-300">{{ essay.comments[5] }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- CHART.JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const competencies = {{ essay.competencies | tojson }};
    
    new Chart(document.getElementById('competencyChart'), {
        type: 'pie',
        data: {
            labels: [
                "Competência 1",
                "Competência 2",
                "Competência 3",
                "Competência 4",
                "Competência 5"
            ],
            datasets: [{
                data: competencies,
                borderWidth: 2,
                backgroundColor: [
                    "#10b981", // Emerald
                    "#3b82f6", // Blue
                    "#f59e0b", // Amber
                    "#ef4444", // Red
                    "#a855f7"  // Purple
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: "bottom",
                    labels: { color: "white" }
                }
            }
        }
    });
</script>

{% endblock %}
