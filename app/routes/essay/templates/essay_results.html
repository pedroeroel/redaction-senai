{% extends 'layout.html' %}
{% block pagename %}Performance{% endblock %}
{% block pagetext %}Veja seu desempenho na redaÃ§Ã£o{% endblock %}
{% set header = True %}
{% set footer = True %}
{% set main = True %}

{% block content %}
Â  Â  <section class="performance-container max-w-3xl mx-auto py-10">
Â  Â  Â  Â  <form id="essayForm" action="/handle_essay_action" method="post"> 
Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <input type="hidden" id="formAction" name="action" value="">
Â  Â  Â  Â  
Â  Â  Â  Â  <h1 class="text-3xl font-bold mb-8">Performance <span id="grade"></span></h1>
Â  Â  Â  Â  <div class="performance-box flex flex-col md:flex-row gap-8 bg-white/10 rounded-lg p-8 shadow">
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  <div class="chart flex-1 flex items-center justify-center max-w-md mx-auto">
Â  Â  Â  Â  Â  Â  <canvas id="pieChart"></canvas>
Â  Â  Â  Â  Â  </div>
            
Â  Â  Â  Â  Â  <div class="description flex-1">
Â  Â  Â  Â  Â  Â  <div class="text-and-bars">
Â  Â  Â  Â  Â  Â  Â  <div class="competency-field mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>CompetÃªncia 1:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="competency-comment-1"></span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="competency-field mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>CompetÃªncia 2:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="competency-comment-2"></span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="competency-field mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>CompetÃªncia 3:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="competency-comment-3"></span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="competency-field mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>CompetÃªncia 4:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="competency-comment-4"></span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="competency-field mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>CompetÃªncia 5:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="competency-comment-5"></span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  <div class="general-comment mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <strong>ComentÃ¡rio geral:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="general-comment"></span>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-4 mt-8">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" onclick="setAction('save')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150 ease-in-out">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… Salvar RedaÃ§Ã£o
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" onclick="setAction('dismiss')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150 ease-in-out">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ğŸ—‘ï¸ Descartar
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </form>
Â  Â  </section>
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  Â  <script src="{{ url_for('static', filename='js/api.js') }}"></script>
Â  Â  <script>
// Initialize results using Jinja2 data passed from Flask
const rawResults = JSON.parse('{{ analysis_results_json | safe }}'); 

const pieChart = new Chart(document.getElementById('pieChart').getContext('2d'), {
Â  type: 'pie',
Â  data: {
Â  Â  labels: ['CompetÃªncia 1', 'CompetÃªncia 2', 'CompetÃªncia 3', 'CompetÃªncia 4', 'CompetÃªncia 5'],
Â  Â  datasets: [{
Â  Â  Â  label: 'Desempenho',
Â  Â  Â  data: [0, 0, 0, 0, 0], 
Â  Â  Â  backgroundColor: ['#ffb380', '#ff9933', '#cc5200', '#ff751a', '#ffa64d'],
Â  Â  Â  borderColor: '#2a1035',
Â  Â  Â  borderWidth: 2
Â  Â  }]
Â  },
Â  options: {
Â  Â  responsive: true,
Â  Â  maintainAspectRatio: false, 
Â  Â  plugins: {
Â  Â  Â  legend: {
Â  Â  Â  Â  display: false
Â  Â  Â  }
Â  Â  }
Â  }
});

function updatePageWithResults(results) {
Â  if (results && Array.isArray(results.competencies)) {
Â  Â  const chartData = results.competencies.slice(0, 5).concat(new Array(5 - results.competencies.length).fill(0));
Â  Â  pieChart.data.datasets[0].data = chartData;
Â  Â  pieChart.update();
Â  }
Â  
Â  if (results && Array.isArray(results.comments)) {
Â  Â  results.comments.forEach((comment, idx) => {
Â  Â  Â  if (idx < 5) {
Â  Â  Â  Â  const commentField = document.getElementById(`competency-comment-${idx + 1}`);
Â  Â  Â  Â  if (commentField) {
Â  Â  Â  Â  Â  commentField.textContent = comment;
Â  Â  Â  Â  }
Â  Â  Â  } else if (idx === 5) {
Â  Â  Â  Â  const generalCommentField = document.getElementById('general-comment');
Â  Â  Â  Â  if (generalCommentField) {
Â  Â  Â  Â  Â  generalCommentField.textContent = comment;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  }
Â  
Â  if (results && typeof results.generalGrade !== 'undefined') {
Â  Â  const gradeField = document.getElementById('grade');
Â  Â  if (gradeField) {
Â  Â  Â  gradeField.textContent = results.generalGrade;
Â  Â  }
Â  }
}

// Sets the hidden 'action' field and submits the form
function setAction(action) {
Â  Â  document.getElementById('formAction').value = action;
}

document.addEventListener('DOMContentLoaded', () => {
Â  Â  // Use the rawResults variable defined by Jinja2
Â  Â  if (rawResults) {
Â  Â  Â  Â  updatePageWithResults(rawResults);
Â  Â  }
});
Â  Â  </script>
{% endblock %}